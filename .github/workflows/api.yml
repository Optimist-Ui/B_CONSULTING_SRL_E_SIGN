name: E-Sign API – Build, Push & Deploy

on:
  push:
    branches:
      - dev
      - uat
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    environment:
      name: ${{ github.ref_name == 'main' && 'production' || (github.ref_name == 'dev' && 'development' || github.ref_name) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set environment variables
        # -----------------------------------------------
        # UPDATES:
        # Dev: esign-api-dev | 4003
        # UAT: esign-api-uat | 4004
        # -----------------------------------------------
        run: |
          echo "ECR_REPO=${{ secrets.ECR_REPO_API }}" >> $GITHUB_ENV
          case "${{ github.ref_name }}" in
            dev)
              echo "ENVIRONMENT=development" >> $GITHUB_ENV
              echo "CONTAINER_NAME=esign-api-dev" >> $GITHUB_ENV
              echo "HOST_PORT=4003" >> $GITHUB_ENV
              # Ensure this secret is updated to 3.87.93.78 in GitHub Env
              echo "EC2_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV 
              ;;
            uat)
              echo "ENVIRONMENT=uat" >> $GITHUB_ENV
              echo "CONTAINER_NAME=esign-api-uat" >> $GITHUB_ENV
              echo "HOST_PORT=4004" >> $GITHUB_ENV
              echo "EC2_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV
              ;;
            main)
              echo "ENVIRONMENT=production" >> $GITHUB_ENV
              echo "CONTAINER_NAME=esign-api-prod" >> $GITHUB_ENV
              echo "HOST_PORT=3001" >> $GITHUB_ENV
              # PRODUCTION Host stays isolated
              echo "EC2_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV 
              ;;
            *)
              echo "ENVIRONMENT=development" >> $GITHUB_ENV
              echo "CONTAINER_NAME=esign-api-dev" >> $GITHUB_ENV
              echo "HOST_PORT=4003" >> $GITHUB_ENV
              echo "EC2_HOST=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV
              ;;
          esac

      - name: Build & Push image
        run: |
          AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"
          AWS_REGION="${{ env.AWS_REGION }}"
          ECR_REPO="${{ env.ECR_REPO }}"
          COMMIT_SHA="${{ github.sha }}"

          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${COMMIT_SHA}"
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

          echo "Building Docker image..."
          docker build -f infra/docker/Dockerfile.api -t $IMAGE_URI .

          echo "Logging into ECR..."
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

          echo "Pushing image to ECR..."
          docker push $IMAGE_URI

          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          OPENAI_MAX_TOKENS: ${{ secrets.OPENAI_MAX_TOKENS }}
          CHATBOT_CONFIDENCE_THRESHOLD: ${{ secrets.CHATBOT_CONFIDENCE_THRESHOLD }}
          CHATBOT_MAX_HISTORY: ${{ secrets.CHATBOT_MAX_HISTORY }}
          IMAGE_URI: ${{ env.IMAGE_URI }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          HOST_PORT: ${{ env.HOST_PORT }}
          SENDGRID_TEMPLATES: ${{ secrets.SENDGRID_TEMPLATES }}
          PORT: ${{ secrets.PORT }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CLIENT_URL: ${{ secrets.CLIENT_URL }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          S3_MAX_FILE_SIZE: ${{ secrets.S3_MAX_FILE_SIZE }}
          S3_SIGNED_URL_EXPIRY: ${{ secrets.S3_SIGNED_URL_EXPIRY }}
          SPRYNG_API_TOKEN: ${{ secrets.SPRYNG_API_TOKEN }}
          BCRYPT_ROUNDS: ${{ secrets.BCRYPT_ROUNDS }}
          REMINDER_CRON: ${{ secrets.REMINDER_CRON }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          VIVA_WALLET_API_KEY: ${{ secrets.VIVA_WALLET_API_KEY }}
          VIVA_WALLET_MERCHANT_ID: ${{ secrets.VIVA_WALLET_MERCHANT_ID }}
          VIVA_WALLET_CLIENT_SECRET: ${{ secrets.VIVA_WALLET_CLIENT_SECRET }}
          VIVA_WALLET_CLIENT_ID: ${{ secrets.VIVA_WALLET_CLIENT_ID }}
          VIVA_WALLET_ACCOUNTS_URL: ${{ secrets.VIVA_WALLET_ACCOUNTS_URL }}
          VIVA_WALLET_CHECKOUT_URL: ${{ secrets.VIVA_WALLET_CHECKOUT_URL }}
          VIVA_WALLET_SOURCE_CODE: ${{ secrets.VIVA_WALLET_SOURCE_CODE }}
          VIVA_WALLET_BASE_URL: ${{ secrets.VIVA_WALLET_BASE_URL }}
        with:
          host: ${{ env.EC2_HOST }} # Changed from secrets to env to support logic above
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCOUNT_ID,AWS_REGION,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,IMAGE_URI,CONTAINER_NAME,HOST_PORT,SENDGRID_TEMPLATES,PORT,MONGO_URI,JWT_SECRET,CLIENT_URL,AWS_S3_BUCKET,S3_MAX_FILE_SIZE,S3_SIGNED_URL_EXPIRY,OPENAI_API_KEY,OPENAI_MODEL,OPENAI_MAX_TOKENS,CHATBOT_CONFIDENCE_THRESHOLD,CHATBOT_MAX_HISTORY,SPRYNG_API_TOKEN,BCRYPT_ROUNDS,REMINDER_CRON,ADMIN_EMAIL,SENDGRID_FROM_EMAIL,SENDGRID_API_KEY,VIVA_WALLET_BASE_URL,VIVA_WALLET_SOURCE_CODE,VIVA_WALLET_API_KEY,VIVA_WALLET_MERCHANT_ID,VIVA_WALLET_CLIENT_SECRET,VIVA_WALLET_CLIENT_ID,VIVA_WALLET_ACCOUNTS_URL,VIVA_WALLET_CHECKOUT_URL
          script: |
            set -e  

            # Variable setup
            ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

            echo "=== Cleanup Old ==="
            docker system prune -f

            echo "=== ECR Login & Pull ==="
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
            docker pull $IMAGE_URI

            echo "=== Stopping Old Container ==="
            docker stop $CONTAINER_NAME || true
            docker rm -f $CONTAINER_NAME || true

            echo "=== Starting Container on $HOST_PORT ==="
            echo "$SENDGRID_TEMPLATES" > /tmp/sendgrid_templates.env

            docker run -d \
              --env-file /tmp/sendgrid_templates.env \
              --name "$CONTAINER_NAME" \
              --restart unless-stopped \
              -p "$HOST_PORT:$PORT" \
              -e "PORT=$PORT" \
              -e "MONGO_URI=$MONGO_URI" \
              -e "JWT_SECRET=$JWT_SECRET" \
              -e "CLIENT_URL=$CLIENT_URL" \
              -e "AWS_REGION=$AWS_REGION" \
              -e "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" \
              -e "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" \
              -e "AWS_S3_BUCKET=$AWS_S3_BUCKET" \
              -e "OPENAI_API_KEY=$OPENAI_API_KEY" \
              -e "OPENAI_MODEL=$OPENAI_MODEL" \
              -e "OPENAI_MAX_TOKENS=$OPENAI_MAX_TOKENS" \
              -e "CHATBOT_CONFIDENCE_THRESHOLD=$CHATBOT_CONFIDENCE_THRESHOLD" \
              -e "CHATBOT_MAX_HISTORY=$CHATBOT_MAX_HISTORY" \
              -e "S3_SIGNED_URL_EXPIRY=$S3_SIGNED_URL_EXPIRY" \
              -e "S3_MAX_FILE_SIZE=$S3_MAX_FILE_SIZE" \
              -e "SPRYNG_API_TOKEN=$SPRYNG_API_TOKEN" \
              -e "VIVA_WALLET_BASE_URL=$VIVA_WALLET_BASE_URL" \
              -e "VIVA_WALLET_SOURCE_CODE=$VIVA_WALLET_SOURCE_CODE" \
              -e "VIVA_WALLET_API_KEY=$VIVA_WALLET_API_KEY" \
              -e "VIVA_WALLET_MERCHANT_ID=$STARTER_MONTHLY_PRICE_ID" \
              -e "VIVA_WALLET_CLIENT_SECRET=$VIVA_WALLET_CLIENT_SECRET" \
              -e "VIVA_WALLET_CLIENT_ID=$VIVA_WALLET_CLIENT_ID" \
              -e "VIVA_WALLET_ACCOUNTS_URL=$VIVA_WALLET_ACCOUNTS_URL" \
              -e "VIVA_WALLET_CHECKOUT_URL=$VIVA_WALLET_CHECKOUT_URL" \
              -e "BCRYPT_ROUNDS=$BCRYPT_ROUNDS" \
              -e "REMINDER_CRON=$REMINDER_CRON" \
              -e "ADMIN_EMAIL=$ADMIN_EMAIL" \
              -e "SENDGRID_FROM_EMAIL=$SENDGRID_FROM_EMAIL" \
              -e "SENDGRID_API_KEY=$SENDGRID_API_KEY" \
              "$IMAGE_URI"

            sleep 5
            docker ps | grep "$CONTAINER_NAME"
            rm -f /tmp/sendgrid_templates.env
            echo "✅ Deployment success for $CONTAINER_NAME"